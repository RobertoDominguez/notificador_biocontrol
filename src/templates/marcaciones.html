<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marcaciones</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }

        .dashboard-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }

        .terminal-card {
            flex: 1 1 300px;
            max-width: 400px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .terminal-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        }

        .card-header {
            background: #667eea;
            color: white;
            text-align: center;
            font-weight: bold;
            padding: 10px;
            font-size: 1.5rem;
        }

        .card-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
            min-height: 280px;
            /* Mantener tamaño uniforme */
        }

        .foto-container {
            width: 90%;
            max-height: 250px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
            display: none;
        }

        .foto-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }

        .nombre-persona {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 5px;
            text-align: center;
            min-height: 30px;
        }

        .codigo,
        .datetime,
        .paquete,
        .saldo,
        .estado,
        .fecha-final {
            text-align: center;
            margin-bottom: 3px;
            font-size: 1.1rem;
            min-height: 22px;
        }

        .status-allowed {
            border: 5px solid #28a745;
        }

        .status-denied {
            border: 5px solid #dc3545;
        }

        .status-warning {
            border: 5px solid #ffc107;
        }

        .image-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
            overflow: hidden;
        }

        #fondo-card {
            position: fixed;
            /* Que se quede fijo al fondo */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            /* Muy importante: detrás del contenido */
        }

        #fondo-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* Ajusta la imagen al tamaño de la pantalla */
            /* filter: brightness(0.5); */
            /* opcional, oscurece para que el texto se vea mejor */
        }
    </style>
</head>

<body>

    <div class="image-container" id="fondo-card">

    </div>

    <h1 id="nombre-gym">Marcaciones</h1>

    <div class="dashboard-container" id="dashboard-container"></div>

    <script>
        let terminales = [];
        const terminalTimers = {};

        document.addEventListener('DOMContentLoaded', () => {
            cargarConfiguracion();
            cargarTerminales();
        });

        // Formato de fecha dd/mm/yyyy
        function formatearFecha(fechaStr) {
            if (!fechaStr) return '';
            const fecha = new Date(fechaStr);
            return fecha.toLocaleDateString('es-ES');
        }

        // Cargar todas las terminales
        function cargarTerminales() {
            fetch('/api/terminales')
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        terminales = data.data;
                        mostrarCardsTerminales();
                        iniciarActualizacionMarcaciones();
                    } else console.error("Error al cargar terminales");
                })
                .catch(err => console.error(err));
        }

        // Crear cards vacíos
        function mostrarCardsTerminales() {
            const container = document.getElementById('dashboard-container');
            container.innerHTML = '';

            terminales.forEach(t => {
                const card = document.createElement('div');
                card.className = 'terminal-card';
                card.id = `terminal-card-${t.name}`;
                card.innerHTML = `
            <div class="card-header">${t.name}</div>
            <div class="card-body">
                <div class="foto-container" id="foto-${t.name}"></div>
                <div class="nombre-persona">&nbsp;</div>
                <div class="codigo">&nbsp;</div>
                <div class="fecha-final">&nbsp;</div>
                <div class="saldo">&nbsp;</div>
                <div class="paquete">&nbsp;</div>
                <div class="estado">&nbsp;</div>
            </div>
        `;
                container.appendChild(card);
            });
        }

        // Actualización periódica
        function iniciarActualizacionMarcaciones() {
            setInterval(() => {
                terminales.forEach(t => {
                    fetch(`/api/marcacion/${t.name}`)
                        .then(res => res.json())
                        .then(data => {
                            if (data.success && data.data && Object.keys(data.data).length > 0) {
                                actualizarCard(t.name, data.data);
                            }
                        })
                        .catch(err => console.error(err));
                });
            }, 1000);
        }

        // Actualizar card
        function actualizarCard(terminalName, marcacion) {
            const card = document.getElementById(`terminal-card-${terminalName}`);
            if (!card) return;

            card.querySelector('.nombre-persona').textContent = marcacion.nombre || '';
            card.querySelector('.codigo').textContent = marcacion.codigo || '';
            card.querySelector('.fecha-final').textContent = marcacion.fecha_fin ? 'venc: ' + formatearFecha(marcacion.fecha_fin) : '';
            card.querySelector('.saldo').textContent = marcacion.saldo_dias != null ? 'Saldo de ' + marcacion.saldo_dias + ' días' : '';
            card.querySelector('.paquete').textContent = marcacion.paquete || '';

            // Foto solo si existe
            const fotoContainer = card.querySelector(`#foto-${terminalName}`);
            if (marcacion.foto && marcacion.foto !== 'Sin Foto') {
                fotoContainer.style.display = 'block';
                fotoContainer.innerHTML = `<img src="/api/imagen/${marcacion.foto}" alt="" onerror="this.onerror=null;this.src='/api/imagen/error.jpg';">`;
            } else {
                fotoContainer.style.display = 'none';
                fotoContainer.innerHTML = '';
            }

            // Estado
            const estadoSpan = card.querySelector('.estado');
            let estadoClass = '';
            let estadoTexto = '';
            if ((marcacion.cercaDeVencer === true || marcacion.cercaDeVencer === 1) && (marcacion.habilitado === true || marcacion.habilitado === 1)) {
                estadoClass = 'status-warning';
                estadoTexto = '⚠ Cerca de Vencer';
            } else if ((marcacion.habilitado === true || marcacion.habilitado === 1) && (marcacion.allowed === true || marcacion.allowed === 1)) {
                estadoClass = 'status-allowed';
                estadoTexto = '✓ Acceso Permitido';
            } else if (marcacion.allowed === 0 || marcacion.allowed === false) {
                estadoClass = 'status-denied';
                estadoTexto = '✗ Acceso Restringido';
            } else {
                estadoClass = 'status-denied';
                estadoTexto = '✗ Acceso Denegado';
            }

            card.classList.remove('status-allowed', 'status-denied', 'status-warning');
            card.classList.add(estadoClass);
            estadoSpan.textContent = estadoTexto;

            // Timer individual por card
            const duracion = (marcacion.duracion_marcacion || 5) * 1000;
            if (terminalTimers[terminalName]) clearTimeout(terminalTimers[terminalName]);
            terminalTimers[terminalName] = setTimeout(() => {
                limpiarCard(terminalName);
            }, duracion);
        }

        // Limpiar card
        function limpiarCard(terminalName) {
            const card = document.getElementById(`terminal-card-${terminalName}`);
            if (!card) return;

            card.querySelector('.nombre-persona').textContent = '';
            card.querySelector('.codigo').textContent = '';
            card.querySelector('.fecha-final').textContent = '';
            card.querySelector('.saldo').textContent = '';
            card.querySelector('.paquete').textContent = '';
            card.querySelector('.estado').textContent = '';

            const fotoContainer = card.querySelector(`#foto-${terminalName}`);
            fotoContainer.style.display = 'none';
            fotoContainer.innerHTML = '';

            card.classList.remove('status-allowed', 'status-denied', 'status-warning');
        }

        function cargarConfiguracion() {
            fetch(`/api/config`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        actualizarInterfazConfig(data.data);
                    } else {
                        console.error('Error al cargar config');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function actualizarInterfazConfig(config) {
            document.getElementById('nombre-gym').textContent = 'Bienvenido a ' + config.NOMBRE_GYM;
            // Actualizar fondo
            const fondoContainer = document.getElementById('fondo-card');
            if (config.FONDO_PATH) {
                fondoContainer.innerHTML = `<img src="/api/fondo" alt="Fondo" class="centered-image">`;
            } else {
                fondoContainer.innerHTML = '';
            }
        }

    </script>
</body>

</html>